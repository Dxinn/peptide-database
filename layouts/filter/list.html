{{ define "main" }}
<div style="padding: 20px; max-width: 1200px; margin: 0 auto; font-family: Arial, sans-serif;">
    <h1 style="color: #27ae60; text-align: center;">ğŸ›ï¸ é«˜çº§ç­›é€‰</h1>
    
    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 30px; margin: 20px 0;">
        <!-- ç­›é€‰æ¡ä»¶é¢æ¿ -->
        <div style="background: #f0f8f0; padding: 25px; border-radius: 10px; height: fit-content;">
            <h3 style="margin-top: 0;">ç­›é€‰æ¡ä»¶</h3>
            
            <!-- é¶ç‚¹ç­›é€‰ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">ğŸ”¬ é¶ç‚¹ç±»å‹</label>
                <select id="targetFilter" multiple style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; height: 100px;">
                    {{ $targets := slice }}
                    {{ range .Site.Data.peptides }}
                        {{ if and .å¤šè‚½é¶ç‚¹ (not (in $targets .å¤šè‚½é¶ç‚¹)) }}
                            {{ $targets = $targets | append .å¤šè‚½é¶ç‚¹ }}
                        {{ end }}
                    {{ end }}
                    {{ range sort $targets }}
                    <option value="{{ . }}">{{ . }}</option>
                    {{ end }}
                </select>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">å¯å¤šé€‰ (Ctrl+ç‚¹å‡»)</div>
            </div>
            
            <!-- åº”ç”¨èŒƒå›´ç­›é€‰ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">ğŸ¯ åº”ç”¨èŒƒå›´</label>
                <select id="applicationFilter" multiple style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; height: 80px;">
                    {{ $applications := slice }}
                    {{ range .Site.Data.peptides }}
                        {{ if and .å¤šè‚½çš„åº”ç”¨èŒƒå›´ (not (in $applications .å¤šè‚½çš„åº”ç”¨èŒƒå›´)) }}
                            {{ $applications = $applications | append .å¤šè‚½çš„åº”ç”¨èŒƒå›´ }}
                        {{ end }}
                    {{ end }}
                    {{ range sort $applications }}
                    <option value="{{ . }}">{{ . }}</option>
                    {{ end }}
                </select>
            </div>
            
            <!-- ä¸´åºŠçŠ¶æ€ç­›é€‰ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">ğŸ¥ ä¸´åºŠçŠ¶æ€</label>
                <select id="clinicalFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">å…¨éƒ¨</option>
                    <option value="Yes">æ˜¯ (Yes)</option>
                    <option value="No">å¦ (No)</option>
                </select>
            </div>
            
            <!-- äº²å’ŒåŠ›èŒƒå›´ -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">ğŸ“Š äº²å’ŒåŠ›èŒƒå›´ (Î¼M)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="number" id="affinityMin" placeholder="æœ€å°å€¼" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <input type="number" id="affinityMax" placeholder="æœ€å¤§å€¼" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
            </div>
            
            <!-- å¤šè‚½ç±»å‹ -->
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">ğŸ§¬ å¤šè‚½ç±»å‹</label>
                <select id="peptideTypeFilter" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">å…¨éƒ¨</option>
                    <option value="L">L-å‹</option>
                    <option value="D">D-å‹</option>
                </select>
            </div>
            
            <!-- æŒ‰é’®ç»„ -->
            <div style="display: grid; gap: 10px;">
                <button onclick="applyFilters()" style="padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    âœ… åº”ç”¨ç­›é€‰
                </button>
                <button onclick="resetFilters()" style="padding: 12px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    ğŸ”„ é‡ç½®ç­›é€‰
                </button>
                <button onclick="exportFilteredData()" style="padding: 12px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    ğŸ“¥ å¯¼å‡ºç»“æœ
                </button>
            </div>
            
            <!-- ç­›é€‰ç»Ÿè®¡ -->
            <div id="filterStats" style="margin-top: 20px; padding: 15px; background: white; border-radius: 5px; border-left: 4px solid #27ae60;">
                <h4 style="margin: 0 0 10px 0;">ğŸ“ˆ ç­›é€‰ç»Ÿè®¡</h4>
                <div id="resultCount">ç­‰å¾…ç­›é€‰...</div>
                <div id="activeFilters" style="font-size: 12px; color: #666; margin-top: 10px;"></div>
            </div>
        </div>
        
        <!-- ç­›é€‰ç»“æœ -->
        <div>
            <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                    <h3 style="margin: 0;" id="resultsTitle">ç­›é€‰ç»“æœ</h3>
                    <div>
                        <span style="margin-right: 15px;">æ’åºæ–¹å¼ï¼š</span>
                        <select id="sortBy" onchange="applySorting()" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="name">å¤šè‚½åç§°</option>
                            <option value="affinity">äº²å’ŒåŠ›</option>
                            <option value="target">é¶ç‚¹</option>
                        </select>
                        <select id="sortOrder" onchange="applySorting()" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; margin-left: 5px;">
                            <option value="asc">å‡åº</option>
                            <option value="desc">é™åº</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ç»“æœè¡¨æ ¼ -->
            <div id="filterResults">
                <div style="text-align: center; padding: 50px; color: #666;">
                    <p>ğŸ›ï¸ è¯·è®¾ç½®ç­›é€‰æ¡ä»¶å¹¶ç‚¹å‡»"åº”ç”¨ç­›é€‰"</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
const peptideData = {{ .Site.Data.peptides | jsonify }};
let filteredData = [];
let currentSort = { by: 'name', order: 'asc' };

// åº”ç”¨ç­›é€‰
function applyFilters() {
    const targetFilter = Array.from(document.getElementById('targetFilter').selectedOptions).map(opt => opt.value);
    const applicationFilter = Array.from(document.getElementById('applicationFilter').selectedOptions).map(opt => opt.value);
    const clinicalFilter = document.getElementById('clinicalFilter').value;
    const affinityMin = parseFloat(document.getElementById('affinityMin').value) || 0;
    const affinityMax = parseFloat(document.getElementById('affinityMax').value) || Infinity;
    const peptideTypeFilter = document.getElementById('peptideTypeFilter').value;
    
    // æ‰§è¡Œç­›é€‰
    filteredData = peptideData.filter(peptide => {
        // é¶ç‚¹ç­›é€‰
        if (targetFilter.length > 0 && !targetFilter.includes(peptide.å¤šè‚½é¶ç‚¹)) {
            return false;
        }
        
        // åº”ç”¨èŒƒå›´ç­›é€‰
        if (applicationFilter.length > 0 && !applicationFilter.includes(peptide.å¤šè‚½çš„åº”ç”¨èŒƒå›´)) {
            return false;
        }
        
        // ä¸´åºŠçŠ¶æ€ç­›é€‰
        if (clinicalFilter && peptide.æ˜¯å¦ä¸´åºŠ !== clinicalFilter) {
            return false;
        }
        
        // äº²å’ŒåŠ›èŒƒå›´ç­›é€‰
        const affinity = parseFloat(peptide.äº²å’ŒåŠ›) || 0;
        if (affinity < affinityMin || affinity > affinityMax) {
            return false;
        }
        
        // å¤šè‚½ç±»å‹ç­›é€‰
        if (peptideTypeFilter && peptide.å¤šè‚½ç±»å‹ !== peptideTypeFilter) {
            return false;
        }
        
        return true;
    });
    
    // åº”ç”¨å½“å‰æ’åº
    applySorting();
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    updateFilterStats(targetFilter, applicationFilter, clinicalFilter, affinityMin, affinityMax, peptideTypeFilter);
}

// åº”ç”¨æ’åº
function applySorting() {
    const sortBy = document.getElementById('sortBy').value;
    const sortOrder = document.getElementById('sortOrder').value;
    currentSort = { by: sortBy, order: sortOrder };
    
    if (filteredData.length === 0) return;
    
    filteredData.sort((a, b) => {
        let valueA, valueB;
        
        switch (sortBy) {
            case 'name':
                valueA = a.å¤šè‚½åç§° || '';
                valueB = b.å¤šè‚½åç§° || '';
                break;
            case 'affinity':
                valueA = parseFloat(a.äº²å’ŒåŠ›) || 0;
                valueB = parseFloat(b.äº²å’ŒåŠ›) || 0;
                break;
            case 'target':
                valueA = a.å¤šè‚½é¶ç‚¹ || '';
                valueB = b.å¤šè‚½é¶ç‚¹ || '';
                break;
            default:
                return 0;
        }
        
        if (typeof valueA === 'string') {
            valueA = valueA.toLowerCase();
            valueB = valueB.toLowerCase();
        }
        
        if (sortOrder === 'asc') {
            return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
            return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
    });
    
    displayResults();
}

// æ˜¾ç¤ºç­›é€‰ç»“æœ
function displayResults() {
    const resultsContainer = document.getElementById('filterResults');
    const resultsTitle = document.getElementById('resultsTitle');
    
    if (filteredData.length === 0) {
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 50px; background: #fff3cd; border-radius: 8px;">
                <p style="color: #856404;">ğŸ” æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»“æœï¼Œè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
            </div>
        `;
        resultsTitle.textContent = 'ç­›é€‰ç»“æœ (0 æ¡)';
        return;
    }
    
    resultsTitle.textContent = `ç­›é€‰ç»“æœ (${filteredData.length} æ¡)`;
    
    let tableHTML = `
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <thead>
                    <tr style="background-color: #27ae60; color: white;">
                        <th style="padding: 12px; text-align: left;">å¤šè‚½åç§°</th>
                        <th style="padding: 12px; text-align: left;">åºåˆ—</th>
                        <th style="padding: 12px; text-align: left;">é¶ç‚¹</th>
                        <th style="padding: 12px; text-align: left;">äº²å’ŒåŠ›</th>
                        <th style="padding: 12px; text-align: left;">åº”ç”¨èŒƒå›´</th>
                        <th style="padding: 12px; text-align: left;">ä¸´åºŠçŠ¶æ€</th>
                        <th style="padding: 12px; text-align: left;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    filteredData.forEach((peptide, index) => {
        tableHTML += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;">
                    <a href="/peptides/${index}/" 
                       style="color: #27ae60; text-decoration: none; font-weight: bold;">
                        ${peptide.å¤šè‚½åç§°}
                    </a>
                </td>
                <td style="padding: 10px; font-family: monospace; font-size: 13px;">
                    <code>${peptide.å¤šè‚½åºåˆ—N_Cç«¯}</code>
                </td>
                <td style="padding: 10px;">${peptide.å¤šè‚½é¶ç‚¹}</td>
                <td style="padding: 10px;">${peptide.äº²å’ŒåŠ›}</td>
                <td style="padding: 10px;">${peptide.å¤šè‚½çš„åº”ç”¨èŒƒå›´}</td>
                <td style="padding: 10px;">
                    <span style="background: ${peptide.æ˜¯å¦ä¸´åºŠ === 'Yes' ? '#4CAF50' : '#ff9800'}; 
                    color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                        ${peptide.æ˜¯å¦ä¸´åºŠ}
                    </span>
                </td>
                <td style="padding: 10px;">
                    <a href="/peptides/${index}/" 
                       style="color: #2196F3; text-decoration: none; font-size: 12px;">
                        æŸ¥çœ‹è¯¦æƒ…
                    </a>
                </td>
            </tr>
        `;
    });
    
    tableHTML += '</tbody></table></div>';
    resultsContainer.innerHTML = tableHTML;
}

// æ›´æ–°ç­›é€‰ç»Ÿè®¡ä¿¡æ¯
function updateFilterStats(targetFilter, applicationFilter, clinicalFilter, affinityMin, affinityMax, peptideTypeFilter) {
    const statsEl = document.getElementById('filterStats');
    const countEl = document.getElementById('resultCount');
    const filtersEl = document.getElementById('activeFilters');
    
    countEl.innerHTML = `<strong>æ‰¾åˆ° ${filteredData.length} æ¡åŒ¹é…æ•°æ®</strong>`;
    
    let activeFilters = [];
    if (targetFilter.length > 0) activeFilters.push(`é¶ç‚¹: ${targetFilter.join(', ')}`);
    if (applicationFilter.length > 0) activeFilters.push(`åº”ç”¨: ${applicationFilter.join(', ')}`);
    if (clinicalFilter) activeFilters.push(`ä¸´åºŠ: ${clinicalFilter}`);
    if (affinityMin > 0 || affinityMax < Infinity) activeFilters.push(`äº²å’ŒåŠ›: ${affinityMin}-${affinityMax} Î¼M`);
    if (peptideTypeFilter) activeFilters.push(`ç±»å‹: ${peptideTypeFilter}`);
    
    filtersEl.innerHTML = activeFilters.length > 0 ? 
        `<strong>å½“å‰ç­›é€‰æ¡ä»¶:</strong><br>${activeFilters.join('<br>')}` : 
        'æš‚æ— ç­›é€‰æ¡ä»¶';
}

// é‡ç½®ç­›é€‰
function resetFilters() {
    document.getElementById('targetFilter').selectedIndex = -1;
    document.getElementById('applicationFilter').selectedIndex = -1;
    document.getElementById('clinicalFilter').value = '';
    document.getElementById('affinityMin').value = '';
    document.getElementById('affinityMax').value = '';
    document.getElementById('peptideTypeFilter').value = '';
    
    filteredData = [];
    document.getElementById('filterResults').innerHTML = `
        <div style="text-align: center; padding: 50px; color: #666;">
            <p>ğŸ›ï¸ è¯·è®¾ç½®ç­›é€‰æ¡ä»¶å¹¶ç‚¹å‡»"åº”ç”¨ç­›é€‰"</p>
        </div>
    `;
    
    document.getElementById('resultCount').textContent = 'ç­‰å¾…ç­›é€‰...';
    document.getElementById('activeFilters').innerHTML = '';
    document.getElementById('resultsTitle').textContent = 'ç­›é€‰ç»“æœ';
}

// å¯¼å‡ºç­›é€‰ç»“æœ
function exportFilteredData() {
    if (filteredData.length === 0) {
        alert('è¯·å…ˆåº”ç”¨ç­›é€‰æ¡ä»¶è·å–ç»“æœ');
        return;
    }
    
    const csvContent = convertToCSV(filteredData);
    downloadFile(csvContent, 'filtered_peptides.csv', 'text/csv');
}

// è¾…åŠ©å‡½æ•°ï¼šè½¬æ¢ä¸ºCSV
function convertToCSV(data) {
    const headers = ['å¤šè‚½åç§°', 'å¤šè‚½åºåˆ—N_Cç«¯', 'å¤šè‚½é¶ç‚¹', 'äº²å’ŒåŠ›', 'å¤šè‚½çš„åº”ç”¨èŒƒå›´', 'æ˜¯å¦ä¸´åºŠ'];
    let csv = headers.join(',') + '\n';
    
    data.forEach(item => {
        const row = headers.map(header => {
            let value = item[header] || '';
            if (typeof value === 'string' && value.includes(',')) {
                value = '"' + value + '"';
            }
            return value;
        });
        csv += row.join(',') + '\n';
    });
    
    return csv;
}

// è¾…åŠ©å‡½æ•°ï¼šä¸‹è½½æ–‡ä»¶
function downloadFile(content, fileName, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    
    link.href = url;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', function() {
    // å¯ä»¥æ·»åŠ ä¸€äº›åˆå§‹åŒ–é€»è¾‘
});
</script>
{{ end }}
