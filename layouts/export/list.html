{{ define "main" }}
<div style="padding: 20px; max-width: 1000px; margin: 0 auto; font-family: Arial, sans-serif;">
    <h1 style="color: #27ae60; text-align: center;">ğŸ“¥ æ•°æ®å¯¼å‡º</h1>
    
    <div style="background: #f0f8f0; padding: 30px; border-radius: 10px; margin: 20px 0;">
        <h3>å¯¼å‡ºé€‰é¡¹</h3>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin: 15px 0;">
            <h4>ğŸ”¸ å¯¼å‡ºèŒƒå›´</h4>
            <div>
                <input type="radio" id="exportAll" name="exportScope" value="all" checked>
                <label for="exportAll">å…¨éƒ¨æ•°æ®</label>
            </div>
            <div style="margin-top: 10px;">
                <input type="radio" id="exportCurrent" name="exportScope" value="current">
                <label for="exportCurrent">å½“å‰ç­›é€‰ç»“æœ</label>
            </div>
        </div>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin: 15px 0;">
            <h4>ğŸ”¸ å¯¼å‡ºæ ¼å¼</h4>
            <div>
                <input type="radio" id="formatCSV" name="exportFormat" value="csv" checked>
                <label for="formatCSV">CSV (Excelå…¼å®¹)</label>
            </div>
            <div style="margin-top: 10px;">
                <input type="radio" id="formatJSON" name="exportFormat" value="json">
                <label for="formatJSON">JSON (ç¨‹åºå¤„ç†)</label>
            </div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 8px; margin: 15px 0;">
            <h4>ğŸ”¸ é€‰æ‹©å¯¼å‡ºå­—æ®µ</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto;">
                <div><input type="checkbox" id="fieldName" checked> <label for="fieldName">å¤šè‚½åç§°</label></div>
                <div><input type="checkbox" id="fieldSequence" checked> <label for="fieldSequence">å¤šè‚½åºåˆ—</label></div>
                <div><input type="checkbox" id="fieldTarget" checked> <label for="fieldTarget">é¶ç‚¹</label></div>
                <div><input type="checkbox" id="fieldAffinity" checked> <label for="fieldAffinity">äº²å’ŒåŠ›</label></div>
                <div><input type="checkbox" id="fieldApplication" checked> <label for="fieldApplication">åº”ç”¨èŒƒå›´</label></div>
                <div><input type="checkbox" id="fieldClinical" checked> <label for="fieldClinical">ä¸´åºŠçŠ¶æ€</label></div>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="selectAllFields()" style="padding: 5px 10px; margin-right: 10px;">å…¨é€‰</button>
                <button onclick="deselectAllFields()" style="padding: 5px 10px;">å…¨ä¸é€‰</button>
            </div>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button onclick="exportData()" style="padding: 15px 30px; background: #27ae60; color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer;">
                ğŸ“¥ å¼€å§‹å¯¼å‡º
            </button>
            <div id="exportStatus" style="margin-top: 15px;"></div>
        </div>
    </div>
</div>

<script>
const colors = {
    success: '#4CAF50',
    error: '#f44336',
    warning: '#ff9800'
};

const peptideData = {{ .Site.Data.peptides | jsonify }};

const fieldMapping = {
    fieldName: 'å¤šè‚½åç§°',
    fieldSequence: 'å¤šè‚½åºåˆ—N_Cç«¯',
    fieldTarget: 'å¤šè‚½é¶ç‚¹',
    fieldAffinity: 'äº²å’ŒåŠ›',
    fieldApplication: 'å¤šè‚½çš„åº”ç”¨èŒƒå›´',
    fieldClinical: 'æ˜¯å¦ä¸´åºŠ'
};

function selectAllFields() {
    Object.keys(fieldMapping).forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) element.checked = true;
    });
}

function deselectAllFields() {
    Object.keys(fieldMapping).forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) element.checked = false;
    });
}

function showStatus(message, type) {
    const statusEl = document.getElementById('exportStatus');
    if (!statusEl) return;
    
    statusEl.innerHTML = `<span style="color: ${colors[type]}; font-weight: bold;">${message}</span>`;
    
    if (type === 'success') {
        setTimeout(() => {
            statusEl.innerHTML = '';
        }, 5000);
    }
}

function exportData() {
    const exportScope = document.querySelector('input[name="exportScope"]:checked')?.value || 'all';
    const exportFormat = document.querySelector('input[name="exportFormat"]:checked')?.value || 'csv';
    
    const selectedFields = Object.keys(fieldMapping).filter(fieldId => {
        const element = document.getElementById(fieldId);
        return element ? element.checked : false;
    }).map(fieldId => fieldMapping[fieldId]);
    
    if (selectedFields.length === 0) {
        showStatus('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå­—æ®µ', 'error');
        return;
    }
    
    showStatus('æ­£åœ¨å‡†å¤‡å¯¼å‡ºæ•°æ®...', 'info');
    
    if (exportFormat === 'csv') {
        exportToCSV(peptideData, selectedFields);
    } else {
        exportToJSON(peptideData, selectedFields);
    }
}

function exportToCSV(data, fields) {
    try {
        let csvContent = fields.join(',') + '\n';
        
        data.forEach(item => {
            const row = fields.map(field => {
                let value = item[field] || '';
                if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                    value = '"' + value.replace(/"/g, '""') + '"';
                }
                return value;
            });
            csvContent += row.join(',') + '\n';
        });
        
        downloadFile(csvContent, 'peptide_data_export.csv', 'text/csv');
        showStatus('CSVå¯¼å‡ºæˆåŠŸï¼', 'success');
        
    } catch (error) {
        showStatus('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
    }
}

function exportToJSON(data, fields) {
    try {
        const filteredData = data.map(item => {
            const filteredItem = {};
            fields.forEach(field => {
                filteredItem[field] = item[field] || '';
            });
            return filteredItem;
        });
        
        const jsonContent = JSON.stringify(filteredData, null, 2);
        downloadFile(jsonContent, 'peptide_data_export.json', 'application/json');
        showStatus('JSONå¯¼å‡ºæˆåŠŸï¼', 'success');
        
    } catch (error) {
        showStatus('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
    }
}

function downloadFile(content, fileName, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    
    link.href = url;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

document.addEventListener('DOMContentLoaded', function() {
    selectAllFields();
});
</script>
{{ end }}
