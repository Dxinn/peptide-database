{{ define "main" }}
<div class="container">
    <h1 class="text-center">ğŸ“Š æ•°æ®å¯è§†åŒ–</h1>
    
    <div class="card p-20">
        <p>è¿™é‡Œå±•ç¤ºäº†å¤šè‚½æ•°æ®åº“çš„ç»Ÿè®¡ä¿¡æ¯å’Œå¯è§†åŒ–å›¾è¡¨ã€‚</p >
    </div>

    {{ $peptides := .Site.Data.peptides }}
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-4 mb-20">
        <div class="card stats-card">
            <div class="stats-number">{{ len $peptides }}</div>
            <div class="stats-label">æ€»è‚½æ•°</div>
        </div>
        <div class="card stats-card">
            <div class="stats-number">
                {{ $targets := slice }}
                {{ range $peptides }}
                    {{ if and .å¤šè‚½é¶ç‚¹ (not (in $targets .å¤šè‚½é¶ç‚¹)) }}
                        {{ $targets = $targets | append .å¤šè‚½é¶ç‚¹ }}
                    {{ end }}
                {{ end }}
                {{ len $targets }}
            </div>
            <div class="stats-label">ç‹¬ç‰¹é¶ç‚¹</div>
        </div>
        <div class="card stats-card">
            <div class="stats-number">
                {{ $clinicalCount := 0 }}
                {{ range $peptides }}
                    {{ if eq .æ˜¯å¦ä¸´åºŠ "Yes" }}{{ $clinicalCount = add $clinicalCount 1 }}{{ end }}
                {{ end }}
                {{ $clinicalCount }}
            </div>
            <div class="stats-label">ä¸´åºŠé˜¶æ®µ</div>
        </div>
        <div class="card stats-card">
            <div class="stats-number">
                {{ $applications := slice }}
                {{ range $peptides }}
                    {{ if and .å¤šè‚½çš„åº”ç”¨èŒƒå›´ (not (in $applications .å¤šè‚½çš„åº”ç”¨èŒƒå›´)) }}
                        {{ $applications = $applications | append .å¤šè‚½çš„åº”ç”¨èŒƒå›´ }}
                    {{ end }}
                {{ end }}
                {{ len $applications }}
            </div>
            <div class="stats-label">åº”ç”¨é¢†åŸŸ</div>
        </div>
    </div>

    <!-- å›¾è¡¨å®¹å™¨ -->
    <div class="grid grid-2 mb-20">
        <div class="card">
            <h3>é¶ç‚¹åˆ†å¸ƒ</h3>
            <canvas id="targetChart" width="400" height="300"></canvas>
        </div>
        <div class="card">
            <h3>ä¸´åºŠçŠ¶æ€åˆ†å¸ƒ</h3>
            <canvas id="clinicalChart" width="400" height="300"></canvas>
        </div>
    </div>

    <div class="grid grid-2 mb-20">
        <div class="card">
            <h3>åº”ç”¨é¢†åŸŸåˆ†å¸ƒ</h3>
            <canvas id="applicationChart" width="400" height="300"></canvas>
        </div>
        <div class="card">
            <h3>äº²å’ŒåŠ›åˆ†å¸ƒ</h3>
            <canvas id="affinityChart" width="400" height="300"></canvas>
        </div>
    </div>
</div>

<!-- å¼•å…¥Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// è·å–å¤šè‚½æ•°æ®
const peptideData = {{ .Site.Data.peptides | jsonify }};

// å‡†å¤‡å›¾è¡¨æ•°æ®
function prepareChartData() {
    // é¶ç‚¹åˆ†å¸ƒ
    const targetCounts = {};
    peptideData.forEach(peptide => {
        const target = peptide.å¤šè‚½é¶ç‚¹ || 'æœªçŸ¥';
        targetCounts[target] = (targetCounts[target] || 0) + 1;
    });
    
    // ä¸´åºŠçŠ¶æ€åˆ†å¸ƒ
    const clinicalCounts = { 'Yes': 0, 'No': 0, 'æœªçŸ¥': 0 };
    peptideData.forEach(peptide => {
        const clinical = peptide.æ˜¯å¦ä¸´åºŠ || 'æœªçŸ¥';
        if (clinical === 'Yes' || clinical === 'No') {
            clinicalCounts[clinical]++;
        } else {
            clinicalCounts['æœªçŸ¥']++;
        }
    });
    
    // åº”ç”¨é¢†åŸŸåˆ†å¸ƒ
    const applicationCounts = {};
    peptideData.forEach(peptide => {
        const application = peptide.å¤šè‚½çš„åº”ç”¨èŒƒå›´ || 'æœªçŸ¥';
        applicationCounts[application] = (applicationCounts[application] || 0) + 1;
    });
    
    // äº²å’ŒåŠ›åˆ†å¸ƒï¼ˆåˆ†ç»„ï¼‰
    const affinityRanges = {
        '0-1 Î¼M': 0,
        '1-10 Î¼M': 0,
        '10-100 Î¼M': 0,
        '>100 Î¼M': 0,
        'æœªçŸ¥': 0
    };
    
    peptideData.forEach(peptide => {
        const affinity = parseFloat(peptide.äº²å’ŒåŠ›);
        if (isNaN(affinity)) {
            affinityRanges['æœªçŸ¥']++;
        } else if (affinity <= 1) {
            affinityRanges['0-1 Î¼M']++;
        } else if (affinity <= 10) {
            affinityRanges['1-10 Î¼M']++;
        } else if (affinity <= 100) {
            affinityRanges['10-100 Î¼M']++;
        } else {
            affinityRanges['>100 Î¼M']++;
        }
    });
    
    return {
        targetCounts,
        clinicalCounts,
        applicationCounts,
        affinityRanges
    };
}

// åˆå§‹åŒ–å›¾è¡¨
document.addEventListener('DOMContentLoaded', function() {
    const chartData = prepareChartData();
    
    // é¶ç‚¹åˆ†å¸ƒå›¾è¡¨
    new Chart(document.getElementById('targetChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(chartData.targetCounts),
            datasets: [{
                label: 'é¶ç‚¹åˆ†å¸ƒ',
                data: Object.values(chartData.targetCounts),
                backgroundColor: '#27ae60'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // ä¸´åºŠçŠ¶æ€åˆ†å¸ƒå›¾è¡¨
    new Chart(document.getElementById('clinicalChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(chartData.clinicalCounts),
            datasets: [{
                data: Object.values(chartData.clinicalCounts),
                backgroundColor: ['#27ae60', '#e74c3c', '#95a5a6']
            }]
        }
    });
    
    // åº”ç”¨é¢†åŸŸåˆ†å¸ƒå›¾è¡¨
    new Chart(document.getElementById('applicationChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(chartData.applicationCounts),
            datasets: [{
                data: Object.values(chartData.applicationCounts),
                backgroundColor: [
                    '#27ae60', '#e74c3c', '#3498db', '#f39c12', 
                    '#9b59b6', '#1abc9c', '#d35400', '#c0392b'
                ]
            }]
        }
    });
    
    // äº²å’ŒåŠ›åˆ†å¸ƒå›¾è¡¨
    new Chart(document.getElementById('affinityChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(chartData.affinityRanges),
            datasets: [{
                label: 'äº²å’ŒåŠ›åˆ†å¸ƒ',
                data: Object.values(chartData.affinityRanges),
                backgroundColor: '#3498db'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
});
</script>
{{ end }}
